name: Continuous Build and Test

on:
  push:
    branches-ignore:
      - 'dev'
    paths-ignore:
      # don't need to re-run the build for now if only markdown changes
      - '**/*.md'
      - 'docs/**'
env:
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true
  
defaults:
  run:
    shell: bash

jobs:

  build:
    strategy:
      fail-fast: false
      matrix:
        godotVersion: ["4.1.3", "4.2.0"]
        targetFramework: ["net6.0", "net7.0"]
    name: Build
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          clean: false # we clean what we want to clean ourselves above, and try to keep some cache
          submodules: recursive

      - name: Set Target Framework ${{ matrix.targetFramework }}
        run: |
          sed -i 's|<TargetFramework>.*<|<TargetFramework>'${{ matrix.targetFramework }}'<|g' YarnSpinner-Godot.csproj

      - uses: chickensoft-games/setup-godot@v1
        name: ðŸ¤– Setup Godot
        with:
          version: ${{ matrix.godotVersion}}
          # Use .NET-enabled version of Godot (the default is also true).
          use-dotnet: true

      - name: ðŸ”¬ Verify Setup
        run: |
          dotnet --version
          godot --version
          
      - name: Build solution
        id: buildSolution
        run: |
          godot --headless --path . --verbose -e --build-solutions --quit 
          dotnet build
        timeout-minutes: 2
        
      - name: Export samples
        id: exportSamples
        run: |

          exportPath=./build/linux64_debug/YarnSpinner-GodotSamples.x86_64
          mkdir -p "$(dirname $exportPath)"
          godot --headless --path . --verbose --export-debug linux_x86_64 "$exportPath" --quit 
          if ! test -f "$exportPath"; then
            echo "::error::Failed to export the debug samples to $exportPath"
            exit 1
          fi
          exportPath=./build/linux64/YarnSpinner-GodotSamples.x86_64
          mkdir -p "$(dirname $exportPath)"
          godot  --headless --path . --verbose --export-release linux_x86_64 "$exportPath" --quit 
          if ! test -f "$exportPath"; then
            echo "::error::Failed to export the release samples to $exportPath"
            exit 1
          fi
        timeout-minutes: 6